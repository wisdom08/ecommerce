name: Auto Re-run PR Workflows on Master Push (Read-only)

on:
  push:
    branches:
      - master

jobs:
  trigger-pr-workflows:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install gh -y

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Find open PRs
        id: find-prs
        run: |
          prs=$(gh pr list --state open --json number,headRefName --jq '.[] | {number: .number, branch: .headRefName}')
          echo "prs=$(echo $prs | base64)" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger workflow for PRs
        run: |
          prs=$(echo "${{ env.prs }}" | base64 --decode)
          for row in $(echo "$prs" | jq -c '.'); do
            pr_number=$(echo $row | jq -r '.number')
            pr_branch=$(echo $row | jq -r '.branch')

            echo "✅ Triggering workflow for PR #$pr_number (Branch: $pr_branch)..."
            gh workflow run pr-check.yml --repo ${{ github.repository }} --ref $pr_branch || echo "⚠️ Failed to trigger workflow for PR #$pr_number ($pr_branch)"
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}